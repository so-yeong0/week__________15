<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Great Gatsby - The Author's Lens</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+KR:wght@300;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap');

        body {
            margin: 0;
            overflow-x: hidden; 
            background-color: #000510; 
            font-family: 'Noto Serif KR', serif;
            cursor: none; 
            height: 200vh; 
        }

        /* 2D 배경 */
        #bg-layer {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('background_gatsby.jpg') no-repeat center center/cover, linear-gradient(to bottom, #000000, #0a1a2a, #001133);
            opacity: 0.6; 
            z-index: 0;
            transition: all 2s ease;
            filter: brightness(0.8) contrast(1.2);
        }

        /* 안개 효과 */
        #fog-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://raw.githubusercontent.com/danielstuart14/CSS_FOG_ANIMATION/master/img/fog1.png') repeat-x;
            background-size: 200% 100%;
            opacity: 0.3;
            z-index: 1;
            pointer-events: none;
            animation: fogMove 60s linear infinite;
        }
        @keyframes fogMove {
            0% { background-position: 0 0; }
            100% { background-position: -200% 0; }
        }

        #canvas-container {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        /* UI 레이어 */
        #ui-layer {
            position: fixed;
            bottom: 10%;
            width: 100%;
            text-align: center;
            z-index: 3;
            color: #fff;
            pointer-events: none; 
            user-select: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .sentence-container {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            text-shadow: 0 0 10px rgba(0, 255, 100, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            letter-spacing: 1px;
            font-style: italic;
        }

        .drop-zone {
            width: 140px;
            height: 50px;
            border-bottom: 1px solid rgba(0, 255, 128, 0.5);
            display: inline-flex;
            justify-content: center;
            align-items: center;
            color: #00ff88; 
            font-weight: bold;
            transition: all 0.3s ease;
            background: rgba(0, 20, 10, 0.3); 
            pointer-events: auto; 
        }

        .drop-zone.highlight {
            border-bottom: 2px solid #00ff88;
            background: rgba(0, 255, 136, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }

        /* 커서 (녹색 불빛) */
        #custom-cursor {
            position: fixed;
            top: 0;
            left: 0;
            width: 20px;
            height: 20px;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            background: #00ff88;
            border-radius: 50%;
            box-shadow: 0 0 15px #00ff88, 0 0 30px #00ff88;
            transition: transform 0.1s, box-shadow 0.3s;
            opacity: 0.8;
        }
        
        /* 아카이브 모달 */
        #archive-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 5, 10, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 2s ease;
            z-index: 100;
        }

        #archive-modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .archive-content {
            background: transparent;
            padding: 50px;
            max-width: 800px;
            text-align: center;
            color: #fff;
            position: relative;
            border-top: 1px solid #00ff88;
            border-bottom: 1px solid #00ff88;
        }
        
        .archive-title {
            font-family: 'Cinzel', serif;
            font-size: 3.5rem;
            color: #00ff88;
            margin-bottom: 30px;
            letter-spacing: 3px;
        }

        .archive-quote {
            font-family: 'Noto Serif KR', serif;
            font-size: 1.3rem;
            line-height: 1.8;
            color: #eee;
            margin-bottom: 40px;
            font-style: italic;
            border-left: 3px solid #00ff88;
            padding-left: 20px;
            display: inline-block;
            text-align: left;
        }

        .archive-desc {
            font-family: 'Noto Serif KR', serif;
            font-size: 1rem;
            line-height: 1.8;
            color: #ccc;
            margin-bottom: 50px;
            text-align: justify; 
            padding: 0 20px;
            word-break: keep-all; 
        }

        .close-btn {
            padding: 15px 50px;
            border: 1px solid #00ff88;
            background: rgba(0, 255, 136, 0.05);
            color: #00ff88;
            cursor: pointer;
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            letter-spacing: 1px;
            transition: all 0.5s;
            pointer-events: auto;
        }
        
        .close-btn:hover {
            background: #00ff88;
            color: #000;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.6);
        }

        /* 뒤로 가기 버튼 */
        #back-btn {
            position: fixed;
            top: 30px;
            left: 30px;
            z-index: 50;
            color: rgba(255, 255, 255, 0.5);
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            pointer-events: auto;
            padding: 10px;
        }

        #back-btn:hover {
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            transform: translateX(-5px);
        }

        #back-btn svg { width: 20px; height: 20px; fill: currentColor; }

        #loading-error-message {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #ff4444; font-family: 'Noto Serif KR', serif; font-size: 1.2rem;
            text-align: center; z-index: 10; display: none;
        }
    </style>
</head>
<body>

    <div id="bg-layer"></div>
    <div id="fog-layer"></div>
    <div id="canvas-container"></div>
    <div id="loading-error-message"></div>
    
    <a href="index.html" id="back-btn">
        <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        BACK TO GALLERY
    </a>

    <div style="position: fixed; top: 30px; width: 100%; text-align: center; color: rgba(0, 255, 136, 0.4); font-family: 'Playfair Display', serif; pointer-events: none; z-index: 5; font-size: 1.1rem; letter-spacing: 2px; font-style: italic;">
        The Green Light at the end of the dock
    </div>

    <!-- UI -->
    <div id="ui-layer">
        <div class="sentence-container">
            "SO WE <span class="drop-zone" id="zone-beat" data-target="BEAT"></span> ON, BOATS <span class="drop-zone" id="zone-against" data-target="AGAINST"></span> THE <span class="drop-zone" id="zone-current" data-target="CURRENT"></span>..."
        </div>
        
        <p style="font-size: 1.1rem; opacity: 0.9; font-family: 'Noto Serif KR', serif; color: #aaddcc; text-shadow: 0 0 5px rgba(0,255,136,0.3);">
            "그리하여 우리는 조류를 거스르는 배처럼 끊임없이 과거로 떠밀려 가면서도..."
        </p>

        <p style="font-size: 0.8rem; opacity: 0.5; font-family: sans-serif; color: #aaa;">
            Drag the floating words to complete the sentence.
        </p>
    </div>

    <!-- 커서 (녹색 불빛) -->
    <div id="custom-cursor"></div>

    <!-- 배경 음악 -->
    <audio id="bgm" loop>
        <source src="gatsby_bgm.mp3" type="audio/mpeg">
    </audio>

    <!-- 아카이브 -->
    <div id="archive-modal">
        <div class="archive-content">
            <h2 class="archive-title">The Great Gatsby</h2>
            
            <div class="archive-quote">
                "So we beat on, boats against the current,<br>
                borne back ceaselessly into the past."<br>
                <br>
                "그리하여 우리는 조류를 거스르는 배처럼 끊임없이 과거로 떠밀려 가면서도 앞으로 앞으로 계속 나아가는 것이다."
            </div>
            
            <div class="archive-desc">
                <p>F. 스콧 피츠제럴드의 &lt;위대한 개츠비&gt;는 1920년대 미국의 '재즈 시대'를 배경으로, 꿈과 사랑을 향한 한 남자의 비극적인 열망을 그립니다.</p>
                <br>
                <p>개츠비가 매일 밤 바라보던 부두 끝의 '녹색 불빛'은 닿을 수 없는 꿈이자 데이지에 대한 사랑, 그리고 되돌리고 싶은 과거를 상징합니다. 우리가 완성한 이 마지막 문장은, 불가능한 꿈(과거)을 향해 끊임없이 노를 젓는 인간의 허망하지만 아름다운 의지를 보여줍니다.</p>
            </div>
            
            <button class="close-btn" onclick="location.reload()">CHASE THE LIGHT</button>
        </div>
    </div>

    <!-- Three.js -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';

        function showErrorMessage(message) {
            const errorDiv = document.getElementById('loading-error-message');
            errorDiv.innerHTML = message;
            errorDiv.style.display = 'block';
            console.error(message);
        }

        // --- 0. 글로우 텍스처 생성 함수 (수정됨: 검은 알갱이 제거) ---
        function createGlowTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 128; 
            canvas.height = 128;
            const context = canvas.getContext('2d');
            
            const gradient = context.createRadialGradient(64, 64, 0, 64, 64, 64);
            // 색상을 순수한 rgba로 정의하고 검은색이 섞이지 않도록 주의
            gradient.addColorStop(0, 'rgba(0, 255, 136, 1)'); // 중심: 밝은 초록
            gradient.addColorStop(0.2, 'rgba(0, 255, 136, 0.6)');
            gradient.addColorStop(0.4, 'rgba(0, 255, 136, 0.2)');
            gradient.addColorStop(1, 'rgba(0, 255, 136, 0)'); // 외곽 투명
            
            context.fillStyle = gradient;
            context.fillRect(0, 0, 128, 128);
            
            return new THREE.CanvasTexture(canvas);
        }


        // --- 1. 씬 초기화 ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        // 짙은 밤안개
        scene.fog = new THREE.FogExp2(0x000510, 0.015); 

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 30); 

        let renderer;
        try {
            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);
        } catch (error) {
            showErrorMessage("WebGL 초기화 실패.");
        }

        if (renderer) { 
            // --- 2. 조명 설정 ---
            const ambientLight = new THREE.AmbientLight(0x001133, 0.5); // 푸른 달빛
            scene.add(ambientLight);

            // 녹색 불빛 (Green Light) - 멀리서 비춤 (선명한 녹색)
            const greenLight = new THREE.PointLight(0x00ff00, 5, 100); // 강도 증가, 선명한 초록 (수정됨)
            greenLight.position.set(0, 5, -20);
            scene.add(greenLight);
            
            // 불빛의 근원지 (빛나는 구 + 글로우)
            // (1) 핵심 광원 (작게, BasicMaterial로 자체 발광)
            const lightGeo = new THREE.SphereGeometry(0.2, 32, 32); 
            const lightMat = new THREE.MeshBasicMaterial({ color: 0x00ff00 }); // 더 선명한 초록 (수정됨)
            const lightMesh = new THREE.Mesh(lightGeo, lightMat);
            lightMesh.position.set(0, 5, -20);
            scene.add(lightMesh);

            // (2) 글로우 효과 (Sprite)
            const spriteMaterial = new THREE.SpriteMaterial({ 
                map: createGlowTexture(), 
                color: 0xffffff, 
                transparent: true, 
                blending: THREE.AdditiveBlending // 빛이 더해지도록
            });
            const glowSprite = new THREE.Sprite(spriteMaterial);
            glowSprite.scale.set(8, 8, 1); // 글로우 크기 조절
            lightMesh.add(glowSprite); 

            // 파티의 금빛 (Gold Particles) - 조명 역할
            const goldLight = new THREE.PointLight(0xffaa00, 0.5, 50);
            goldLight.position.set(10, 10, 10);
            scene.add(goldLight);


            // --- 3. 오브젝트 생성 ---
            const words = []; 

            // (A) 밤바다 (Water)
            const waterGeometry = new THREE.PlaneGeometry(200, 200, 64, 64);
            const waterMaterial = new THREE.MeshStandardMaterial({
                color: 0x001e36,
                roughness: 0.1,
                metalness: 0.8,
                wireframe: false,
            });
            const waterMesh = new THREE.Mesh(waterGeometry, waterMaterial);
            waterMesh.rotation.x = -Math.PI / 2;
            waterMesh.position.y = -2;
            scene.add(waterMesh);

            // (B) 3D 텍스트 (BEAT, AGAINST, CURRENT)
            const fontLoader = new FontLoader();
            fontLoader.load('https://cdn.jsdelivr.net/npm/three@0.160.0/examples/fonts/helvetiker_bold.typeface.json', function (font) {
                
                const textMaterial = new THREE.MeshPhysicalMaterial({ 
                    color: 0xffffff, 
                    emissive: 0x004422, 
                    metalness: 0.5, 
                    roughness: 0.2,
                    transmission: 0.5, 
                    thickness: 1,
                    clearcoat: 1
                });

                const createWord = (text, x, y, z) => {
                    const geometry = new TextGeometry(text, {
                        font: font, size: 1.0, height: 0.2, curveSegments: 12,
                        bevelEnabled: true, bevelThickness: 0.02, bevelSize: 0.01, bevelSegments: 3
                    });
                    geometry.center();
                    const mesh = new THREE.Mesh(geometry, textMaterial);
                    mesh.position.set(x, y, z);
                    
                    mesh.userData = { 
                        text: text, 
                        isDragging: false, 
                        floatOffset: Math.random() * 100,
                        basePos: new THREE.Vector3(x, y, z) 
                    };
                    scene.add(mesh);
                    words.push(mesh);
                };

                // 단어 위치 분산 배치
                createWord('BEAT', -10, 5, 0);      
                createWord('AGAINST', 0, 8, -2);    
                createWord('CURRENT', 10, 6, 2);    

            });
            
            // (C) 금빛 파티클
            const particleGeo = new THREE.BufferGeometry();
            const particleCount = 200;
            const posArray = new Float32Array(particleCount * 3);
            
            for(let i=0; i<particleCount * 3; i++) {
                posArray[i] = (Math.random() - 0.5) * 50; 
            }
            
            particleGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const particleMat = new THREE.PointsMaterial({
                size: 0.2,
                color: 0xffdd44,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            });
            const particleSystem = new THREE.Points(particleGeo, particleMat);
            scene.add(particleSystem);


            // --- 4. 인터랙션 ---
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            const plane = new THREE.Plane(new THREE.Vector3(0, 0, 1), 0);
            let selectedObject = null;
            let offset = new THREE.Vector3();
            let intersection = new THREE.Vector3();

            const cursor = document.getElementById('custom-cursor');
            
            // 음악 재생 시도 (사용자 상호작용 시)
            window.addEventListener('mousedown', () => {
                const bgm = document.getElementById('bgm');
                if (bgm.paused) {
                    bgm.play().catch(e => console.log("Audio play failed (interaction required):", e));
                }
            }, { once: true });

            document.addEventListener('mousemove', (e) => {
                cursor.style.left = e.clientX + 'px';
                cursor.style.top = e.clientY + 'px';
                
                mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                
                raycaster.setFromCamera(mouse, camera);

                if (selectedObject) {
                    if (raycaster.ray.intersectPlane(plane, intersection)) {
                        selectedObject.position.copy(intersection.sub(offset));
                    }
                } else {
                    const intersects = raycaster.intersectObjects(words);
                    if (intersects.length > 0) {
                        cursor.style.transform = 'translate(-50%, -50%) scale(2)';
                        cursor.style.boxShadow = '0 0 20px #00ff88, 0 0 40px #00ff88';
                    } else {
                        cursor.style.transform = 'translate(-50%, -50%) scale(1)';
                        cursor.style.boxShadow = '0 0 15px #00ff88, 0 0 30px #00ff88';
                    }
                }
            });

            window.addEventListener('mousedown', (e) => {
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(words);
                if (intersects.length > 0) {
                    selectedObject = intersects[0].object;
                    selectedObject.userData.isDragging = true;
                    selectedObject.material.color.set(0x00ff88); 
                    selectedObject.material.emissive.set(0x005522);

                    plane.setFromNormalAndCoplanarPoint(camera.getWorldDirection(plane.normal), selectedObject.position);

                    if (raycaster.ray.intersectPlane(plane, intersection)) {
                        offset.copy(intersection).sub(selectedObject.position);
                    }
                }
            });

            window.addEventListener('mouseup', (e) => {
                if (selectedObject) {
                    const screenPos = selectedObject.position.clone().project(camera);
                    const x = (screenPos.x * .5 + .5) * window.innerWidth;
                    const y = (-(screenPos.y * .5) + .5) * window.innerHeight;

                    checkDropZone(x, y, selectedObject);

                    selectedObject.userData.isDragging = false;
                    selectedObject.material.color.set(0xffffff); 
                    selectedObject.material.emissive.set(0x004422);
                    selectedObject = null;
                }
            });

            let correctCount = 0;
            function checkDropZone(x, y, object) {
                const text = object.userData.text;
                const zone = document.getElementById(`zone-${text.toLowerCase()}`);

                if (zone) {
                    const rect = zone.getBoundingClientRect();
                    if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                        zone.textContent = text;
                        zone.classList.add('highlight');
                        
                        scene.remove(object);
                        const index = words.indexOf(object);
                        if (index > -1) words.splice(index, 1);

                        correctCount++;
                        if (correctCount === 3) { 
                            setTimeout(triggerWin, 500);
                        }
                    }
                }
            }

            function triggerWin() {
                // 성공 시: 안개가 걷히고 녹색 불빛이 강렬해짐
                document.getElementById('bg-layer').style.filter = 'brightness(1.2) contrast(1.5) hue-rotate(30deg)';
                document.getElementById('bg-layer').style.opacity = '1';
                document.getElementById('fog-layer').style.opacity = '0'; 
                
                // 불빛 강화
                lightMesh.scale.set(3, 3, 3); 
                glowSprite.scale.set(15, 15, 1); 
                greenLight.intensity = 5;

                document.getElementById('archive-modal').classList.add('active');
                document.body.style.cursor = 'auto';
                document.getElementById('custom-cursor').style.display = 'none';
            }

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // --- 5. 애니메이션 루프 ---
            function animate() {
                requestAnimationFrame(animate);

                const time = Date.now() * 0.001;
                
                // 1. 물결 애니메이션
                const positionAttribute = waterGeometry.attributes.position;
                for ( let i = 0; i < positionAttribute.count; i ++ ) {
                    const y = 0.5 * Math.sin( i / 5 + ( time + i ) / 7 );
                    positionAttribute.setZ( i, y ); 
                }
                positionAttribute.needsUpdate = true;

                // 2. 녹색 불빛 깜빡임
                greenLight.intensity = 2 + Math.sin(time * 2) * 0.5;
                glowSprite.material.opacity = 0.6 + Math.sin(time * 2) * 0.2;

                // 3. 텍스트 애니메이션
                words.forEach((word) => {
                    if (!word.userData.isDragging) {
                        word.position.y = word.userData.basePos.y + Math.sin(time + word.userData.floatOffset) * 0.3;
                        word.rotation.z = Math.sin(time * 0.5) * 0.05; 
                    }
                });
                
                // 4. 파티클 움직임
                particleSystem.rotation.y += 0.001;
                particleSystem.position.y = Math.sin(time * 0.5);

                renderer.render(scene, camera);
            }

            animate();
        } 
    </script>
</body>
</html>